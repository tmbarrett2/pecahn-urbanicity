---
title: "Urbanicity Index for Anthropological Field Sites"
author: "Tyler Barrett, Lev Kolinski, Marina Watowich, Amanda Lea, and Melanie Martin"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    theme: flatly
---

# Introduction

This tutorial demonstrates how to compute and visualize urbanicity metrics for anthropological field sites using the `pecahnurbanicity` package, developed as part of the [**Population Ecology, Aging, and Health Network (PEcAHN)**](https://sites.duke.edu/pecahn/).

These tools integrate multiple open-access datasets, including OpenStreetMap (OSM) infrastructure data, raster-based friction surfaces, population density grids, and nighttime light imagery. The package supports multi-year analysis to track urbanization trends over time.

------------------------------------------------------------------------

# Installation

You can install the development version of **pecahnurbanicity** directly from GitHub:

``` r
# install.packages("devtools")
devtools::install_github("tmbarrett2/pecahn-urbanicity/pecahnurbanicity")
```

Then load the package:

``` r
library(pecahnurbanicity)
```

------------------------------------------------------------------------

# Required Data

To replicate the examples below, you will need several publicly available datasets:

1.  **Friction surface raster** (for travel time measures):\
    *Source:* Malaria Atlas Project – Accessibility to Healthcare\
    <https://malariaatlas.org/project-resources/accessibility-to-healthcare/>\
    *Reference:* Weiss et al. (2020). *Nature Medicine*, 26(12), 1835–1842. DOI: [10.1038/s41591-020-1059-1](https://doi.org/10.1038/s41591-020-1059-1)

2.  **Population density rasters** (for multi-year population density estimation):\
    *Source:* WorldPop Global Project Population Data\
    <https://www.worldpop.org/>\
    *Reference:* WorldPop (www.worldpop.org - School of Geography and Environmental Science, University of Southampton)

3.  **Nighttime light imagery** (for multi-year light intensity measures):\
    *Source:* Earth Observation Group - VIIRS Nighttime Light\
    <https://eogdata.mines.edu/products/vnl/>\
    *Reference:* Elvidge et al. (2021). *Remote Sensing*, 13(5), 922. DOI: [10.3390/rs13050922](https://doi.org/10.3390/rs13050922)

PEcAHN members can download these data files from the shared Google Drive folder:\
<https://drive.google.com/drive/u/0/folders/1C6RWI7yhAM9UDjwMc7w9nxW30W5u3wee>

Save the raster files to a local folder (e.g., `pecahn-urbanicity/test_data/`).

------------------------------------------------------------------------

# Setup

``` r
# Install dependencies if not already available
# install.packages(c("osmdata", "sf", "raster", "gdistance", "ggplot2", "dplyr"))

# Load the package
library(pecahnurbanicity)
```

`pecahnurbanicity` has help documentation. For any function, you can use `?function-name` to bring up the documentation.

Set your local file path to where the rasters and site coordinate files are stored:

``` r
fp <- "your_local_path/pecahn-urbanicity/test_data"
```

------------------------------------------------------------------------

# Load Example Data

Two example datasets are provided:

1.  **Boundary-defined communities** (`test_data_boundaries.csv`)\
    Communities with fully specified bounding boxes (north/south/east/west coordinates).

2.  **Point-defined communities** (`test_data_single_point.csv`)\
    Communities defined by a single central point and a user defined radius.

``` r
test_data_boundaries <- read.csv(file.path(fp, "test_data_boundaries.csv"))
test_data_single_point <- read.csv(file.path(fp, "test_data_single_point.csv"))
```

------------------------------------------------------------------------

# Create Bounding Boxes

Use `create_bounding_boxes()` to generate bounding boxes for each community.

For optimal results, create **two sets of bounding boxes**:
- **Local bounding boxes** (1-2 km) for community-level measures like population density, nighttime lights, and infrastructure counts
- **Regional bounding boxes** (5 km) for distance measures to facilities that may be further away

``` r
# Create local bounding boxes for community-level measures
bbox_1km <- create_bounding_boxes(test_data_single_point, distance_km = 1)

# Create regional bounding boxes for distance searches
bbox_5km <- create_bounding_boxes(test_data_single_point, distance_km = 5)

# Or use the same size for both if appropriate
bbox_boundaries <- create_bounding_boxes(test_data_boundaries)
```

-   The **local bounding box** defines the spatial extent for population density, nighttime lights, building density, and counts of local infrastructure (shops, financial services, transport stops, cell towers).
-   The **regional bounding box** defines the starting search area for distance measures (healthcare, schools, paved roads, urban centers). The search will expand from this area until facilities are found.
-   If your dataset includes only a central point, the function expands outward by the given radius (default: 5 km).

------------------------------------------------------------------------

# Compute Urbanicity Measures

## Single-Year Analysis

For a single year of population and nighttime light data:

``` r
test_results_single <- compute_urbanicity_iterative(
  local_bboxes = bbox_1km,
  regional_bboxes = bbox_5km,
  metrics = "all",
  search_buffer = 10,  # Expand search by ~1,000 km as needed
  friction_surface_path  = file.path(fp, "friction_surface_walking.geotiff"),
  population_raster_paths = file.path(fp, "worldpop/global_pop_2020_CN_1km_R2025A_UA_v1.tif"),
  nighttime_light_paths   = file.path(fp, "viirs/extracted/VNL_v21_npp_2020_global_vcmslcfg_c202205302300.average_masked.dat.tif"),
  verbose = FALSE
)
```

**Note:** If you only have one set of bounding boxes, you can omit `regional_bboxes` and the function will use `local_bboxes` for all measures:

``` r
test_results_single <- compute_urbanicity_iterative(
  local_bboxes = bbox_5km,
  metrics = "all",
  friction_surface_path  = file.path(fp, "friction_surface_walking.geotiff"),
  population_raster_paths = file.path(fp, "worldpop/global_pop_2020_CN_1km_R2025A_UA_v1.tif"),
  nighttime_light_paths   = file.path(fp, "viirs/extracted/VNL_v21_npp_2020_global_vcmslcfg_c202205302300.average_masked.dat.tif")
)
```

## Multi-Year Analysis

To track urbanization trends over time, provide vectors of raster file paths for multiple years:

``` r
# Define population raster paths (2015-2025)
worldpop_files <- c(
  file.path(fp, "worldpop/global_pop_2015_CN_1km_R2025A_UA_v1.tif"),
  file.path(fp, "worldpop/global_pop_2016_CN_1km_R2025A_UA_v1.tif"),
  file.path(fp, "worldpop/global_pop_2017_CN_1km_R2025A_UA_v1.tif"),
  file.path(fp, "worldpop/global_pop_2018_CN_1km_R2025A_UA_v1.tif"),
  file.path(fp, "worldpop/global_pop_2019_CN_1km_R2025A_UA_v1.tif"),
  file.path(fp, "worldpop/global_pop_2020_CN_1km_R2025A_UA_v1.tif"),
  file.path(fp, "worldpop/global_pop_2021_CN_1km_R2025A_UA_v1.tif"),
  file.path(fp, "worldpop/global_pop_2022_CN_1km_R2025A_UA_v1.tif"),
  file.path(fp, "worldpop/global_pop_2023_CN_1km_R2025A_UA_v1.tif"),
  file.path(fp, "worldpop/global_pop_2024_CN_1km_R2025A_UA_v1.tif"),
  file.path(fp, "worldpop/global_pop_2025_CN_1km_R2025A_UA_v1.tif")
)

# Define nighttime light paths (2013-2024)
nightlight_files <- c(
  file.path(fp, "viirs/extracted/VNL_v21_npp_2013_global_vcmcfg_c202205302300.average_masked.dat.tif"),
  file.path(fp, "viirs/extracted/VNL_v21_npp_2014_global_vcmslcfg_c202205302300.average_masked.dat.tif"),
  file.path(fp, "viirs/extracted/VNL_v21_npp_2015_global_vcmslcfg_c202205302300.average_masked.dat.tif"),
  file.path(fp, "viirs/extracted/VNL_v21_npp_2016_global_vcmslcfg_c202205302300.average_masked.dat.tif"),
  file.path(fp, "viirs/extracted/VNL_v21_npp_2017_global_vcmslcfg_c202205302300.average_masked.dat.tif"),
  file.path(fp, "viirs/extracted/VNL_v21_npp_2018_global_vcmslcfg_c202205302300.average_masked.dat.tif"),
  file.path(fp, "viirs/extracted/VNL_v21_npp_2019_global_vcmslcfg_c202205302300.average_masked.dat.tif"),
  file.path(fp, "viirs/extracted/VNL_v21_npp_2020_global_vcmslcfg_c202205302300.average_masked.dat.tif"),
  file.path(fp, "viirs/extracted/VNL_v21_npp_2021_global_vcmslcfg_c202205302300.average_masked.dat.tif"),
  file.path(fp, "viirs/extracted/VNL_v22_npp-j01_2022_global_vcmslcfg_c202303062300.average_masked.dat.tif"),
  file.path(fp, "viirs/extracted/VNL_npp_2023_global_vcmslcfg_v2_c202402081600.average_masked.dat.tif"),
  file.path(fp, "viirs/extracted/VNL_npp_2024_global_vcmslcfg_v2_c202502261200.average_masked.dat.tif")
)

# Compute multi-year urbanicity metrics
test_results_multiyear <- compute_urbanicity_iterative(
  local_bboxes = bbox_1km,
  regional_bboxes = bbox_5km,
  metrics = "all",
  search_buffer = 10,
  friction_surface_path   = file.path(fp, "friction_surface_walking.geotiff"),
  population_raster_paths = worldpop_files,
  nighttime_light_paths   = nightlight_files,
  verbose = FALSE
)
```

Years are automatically extracted from the filenames (e.g., `_2020_`), and the resulting columns are named:
- `pop_density_2015`, `pop_density_2016`, ..., `pop_density_2025`
- `nighttime_light_2013`, `nighttime_light_2014`, ..., `nighttime_light_2024`

## Subset of Metrics

You can also compute only selected metrics:

``` r
test_results_subset <- compute_urbanicity_iterative(
  local_bboxes = bbox_1km,
  regional_bboxes = bbox_5km,
  metrics = c("roads", "shops", "healthcare", "schools", "population", "nighttime_light"),
  search_buffer = 1,
  friction_surface_path   = file.path(fp, "friction_surface_walking.geotiff"),
  population_raster_paths = worldpop_files,
  nighttime_light_paths   = nightlight_files
)
```

## Large Datasets (>5 Locations)
If computing urbanicity metrics on a dataset containing information for many communities (e.g., >5 locations), it may be advisable to run the `compute_urbanicity_iterative()` function within a `for` loop to batch 5 communities at a time. This may help to avoid timeout issues related to accessing OSM data.

```r
# Example `for` loop for computing urbanicity metrics on dataset containing locations for many (e.g., >5) communities

# Create local bounding boxes for community-level measures
bbox_1km <- create_bounding_boxes(test_data_single_point, distance_km = 1)

# Create regional bounding boxes for distance searches
bbox_5km <- create_bounding_boxes(test_data_single_point, distance_km = 5)

# Count number of communities 
n <- length(bbox_1km)

# Create empty list object to store generated data
results_list <- list()

# Run `for` loop to process 5 communities at a time, storing generated dataframes within the `results_list` object. Dataframes will be named according to the community numbers they contain (e.g., 1_5, 6_10, etc.):

for (start_idx in seq(1, n, by = 5)) {
  
  end_idx <- min(start_idx + 4, n)
  idx_range <- start_idx:end_idx 
  
  message("Processing communities ", start_idx, " to ", end_idx)
  
  # Run urbanicity computation
  res <- compute_urbanicity_iterative(
    local_bboxes        = bbox_1km[idx_range],
    regional_bboxes     = bbox_5km[idx_range],
    metrics             = "all",
    search_buffer       = 10,
    friction_surface_path   = file.path(fp, "friction_surface_walking.geotiff"),
    population_raster_paths = file.path(fp, "worldpop/global_pop_2024_CN_1km_R2025A_UA_v1.tif"),
    nighttime_light_paths   = file.path(fp, "viirs/VNL_npp_2024_global_vcmslcfg_v2_c202502261200.average_masked.dat.tif"),
    verbose = TRUE
  )
  
  # Store results
  results_list[[paste0(start_idx, "_", end_idx)]] <- res
}

# To merge batched dataframes into a single combined dataframe:

combined_df <- dplyr::bind_rows(results_list, .id = "batch")

```

------------------------------------------------------------------------

# Visualize Results

## Summary Plots

The `create_summary_plots()` function automatically generates summary plots for all numeric variables.

``` r
summary_plots <- create_summary_plots(test_results_multiyear)

# Example plots for infrastructure metrics
summary_plots$pct_paved_roads
summary_plots$travel_time_healthcare_min

# Example plots for single-year time-varying metrics
summary_plots$pop_density_2020
summary_plots$nighttime_light_2020
```

## Temporal Trend Plots

For multi-year data, use `create_temporal_plots()` to visualize changes over time:

``` r
temporal_plots <- create_temporal_plots(test_results_multiyear)

# View population density trends
temporal_plots$pop_density

# View nighttime light intensity trends
temporal_plots$nighttime_light
```

## All Plots at Once

You can generate both summary and temporal plots simultaneously:

``` r
all_plots <- create_all_plots(test_results_multiyear)

# Access summary plots
all_plots$summary_plots$pct_paved_roads
all_plots$summary_plots$travel_time_healthcare_min

# Access temporal plots
all_plots$temporal_plots$pop_density
all_plots$temporal_plots$nighttime_light
```

------------------------------------------------------------------------

# Output Interpretation

Each column in the resulting data frame corresponds to a specific urbanicity indicator:

## Infrastructure Metrics (Time-Invariant)

| Variable | Description |
|---------------------------------|---------------------------------------|
| `pct_paved_roads` | Percent of total road length that is paved |
| `travel_time_healthcare_min` | Estimated walking time (min) to nearest healthcare facility |
| `travel_time_school_min` | Estimated walking time (min) to nearest school |
| `travel_time_urban_center_min` | Estimated walking time (min) to nearest urban center |
| `n_shops` | Number of commercial points of interest |
| `n_financial` | Number of financial institutions (ATMs, banks) |
| `n_transport_stops` | Number of public transport nodes |
| `n_cell_towers` | Number of mobile phone cell towers |
| `building_density` | Proportion of built-up land area (%) |

## Time-Varying Metrics (Multi-Year)

| Variable | Description |
|---------------------------------|---------------------------------------|
| `pop_density_YYYY` | Population density (per km²) for year YYYY |
| `nighttime_light_YYYY` | Mean nighttime light intensity for year YYYY |

These indicators can be aggregated or combined into composite indices of urbanicity, and the multi-year data enables longitudinal analysis of urbanization processes.

------------------------------------------------------------------------


# Citation

If you use this package in your research, please cite:

Barrett, T., Kolinski, L., Watowich, M., Lea, A., & Martin, M. (2025). pecahnurbanicity: Tools for computing urbanicity metrics for anthropological field sites. R package version 0.2.0. https://github.com/tmbarrett2/pecahn-urbanicity

------------------------------------------------------------------------
